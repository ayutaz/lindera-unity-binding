name: Build Native Libraries

on:
  push:
    branches: [main]
    paths:
      - 'native/**'
      - '.github/workflows/build-native.yml'
  pull_request:
    branches: [main]
    paths:
      - 'native/**'
      - '.github/workflows/build-native.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Build Windows x64
        working-directory: native/lindera-ffi
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Upload Windows DLL
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: native/lindera-ffi/target/x86_64-pc-windows-msvc/release/lindera_ffi.dll

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Add targets
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Build macOS Intel
        working-directory: native/lindera-ffi
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build macOS Apple Silicon
        working-directory: native/lindera-ffi
        run: cargo build --release --target aarch64-apple-darwin

      - name: Create Universal Binary
        run: |
          lipo -create \
            native/lindera-ffi/target/x86_64-apple-darwin/release/liblindera_ffi.dylib \
            native/lindera-ffi/target/aarch64-apple-darwin/release/liblindera_ffi.dylib \
            -output liblindera_ffi.dylib

      - name: Upload macOS Universal dylib
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: liblindera_ffi.dylib

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Build Linux x64
        working-directory: native/lindera-ffi
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Upload Linux so
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: native/lindera-ffi/target/x86_64-unknown-linux-gnu/release/liblindera_ffi.so

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Add iOS target
        run: rustup target add aarch64-apple-ios

      - name: Build iOS
        working-directory: native/lindera-ffi
        run: cargo build --release --target aarch64-apple-ios

      - name: Upload iOS static library
        uses: actions/upload-artifact@v4
        with:
          name: ios-arm64
          path: native/lindera-ffi/target/aarch64-apple-ios/release/liblindera_ffi.a

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Install Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Add Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi

      - name: Setup cargo config for Android
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-linux-android]
          ar = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"

          [target.armv7-linux-androideabi]
          ar = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang"
          EOF

      - name: Build Android ARM64
        working-directory: native/lindera-ffi
        run: cargo build --release --target aarch64-linux-android

      - name: Build Android ARMv7
        working-directory: native/lindera-ffi
        run: cargo build --release --target armv7-linux-androideabi

      - name: Upload Android ARM64
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64
          path: native/lindera-ffi/target/aarch64-linux-android/release/liblindera_ffi.so

      - name: Upload Android ARMv7
        uses: actions/upload-artifact@v4
        with:
          name: android-armv7
          path: native/lindera-ffi/target/armv7-linux-androideabi/release/liblindera_ffi.so

  # Collect all artifacts and create a release package
  package:
    needs: [build-windows, build-macos, build-linux, build-ios, build-android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize plugins
        run: |
          mkdir -p plugins/x86_64
          mkdir -p plugins/macOS
          mkdir -p plugins/Linux
          mkdir -p plugins/iOS
          mkdir -p plugins/Android/libs/arm64-v8a
          mkdir -p plugins/Android/libs/armeabi-v7a

          cp artifacts/windows-x64/lindera_ffi.dll plugins/x86_64/
          cp artifacts/macos-universal/liblindera_ffi.dylib plugins/macOS/
          cp artifacts/linux-x64/liblindera_ffi.so plugins/Linux/
          cp artifacts/ios-arm64/liblindera_ffi.a plugins/iOS/
          cp artifacts/android-arm64/liblindera_ffi.so plugins/Android/libs/arm64-v8a/
          cp artifacts/android-armv7/liblindera_ffi.so plugins/Android/libs/armeabi-v7a/

      - name: Upload combined package
        uses: actions/upload-artifact@v4
        with:
          name: unity-plugins
          path: plugins/
